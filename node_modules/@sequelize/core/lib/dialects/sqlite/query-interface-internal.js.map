{
  "version": 3,
  "sources": ["../../../src/dialects/sqlite/query-interface-internal.ts"],
  "sourcesContent": ["import { ForeignKeyConstraintError } from '../../errors';\nimport { QueryTypes } from '../../query-types';\nimport type { QueryRawOptions, Sequelize } from '../../sequelize';\nimport { TransactionNestMode } from '../../transaction';\nimport type { TableOrModel } from '../abstract/query-generator-typescript';\nimport { AbstractQueryInterfaceInternal } from '../abstract/query-interface-internal';\nimport type { SqliteDialect } from './index.js';\nimport type { SqliteQueryGenerator } from './query-generator';\nimport type { SqliteColumnsDescription } from './query-interface.types';\nimport { withSqliteForeignKeysOff } from './sqlite-utils';\n\nexport class SqliteQueryInterfaceInternal extends AbstractQueryInterfaceInternal {\n  constructor(readonly dialect: SqliteDialect) {\n    super(dialect);\n  }\n\n  get #sequelize(): Sequelize {\n    return this.dialect.sequelize;\n  }\n\n  get #queryGenerator(): SqliteQueryGenerator {\n    return this.dialect.queryGenerator;\n  }\n\n  /**\n   * Alters a table in sqlite.\n   * Workaround for sqlite's limited alter table support.\n   *\n   * @param tableName\n   * @param columns\n   * @param options\n   */\n  async alterTableInternal(\n    tableName: TableOrModel,\n    columns: SqliteColumnsDescription,\n    options?: QueryRawOptions,\n  ): Promise<void> {\n    const table = this.#queryGenerator.extractTableDetails(tableName);\n\n    await withSqliteForeignKeysOff(this.#sequelize, options, async () => {\n      await this.#sequelize.transaction(\n        {\n          nestMode: TransactionNestMode.savepoint,\n          transaction: options?.transaction,\n        },\n        async () => {\n          const indexes = await this.#sequelize.queryInterface.showIndex(tableName, options);\n          for (const index of indexes) {\n            // This index is reserved by SQLite, we can't add it through addIndex and must use \"UNIQUE\" on the column definition instead.\n            if (!index.name.startsWith('sqlite_autoindex_')) {\n              continue;\n            }\n\n            if (!index.unique) {\n              continue;\n            }\n\n            for (const field of index.fields) {\n              if (columns[field.attribute]) {\n                columns[field.attribute].unique = true;\n              }\n            }\n          }\n\n          const sql = this.#queryGenerator._replaceTableQuery(tableName, columns);\n          await this.executeQueriesSequentially(sql, { ...options, raw: true });\n\n          // Run a foreign keys integrity check\n          const foreignKeyCheckResult = await this.#sequelize.queryRaw(\n            this.#queryGenerator.foreignKeyCheckQuery(tableName),\n            {\n              ...options,\n              type: QueryTypes.SELECT,\n            },\n          );\n\n          if (foreignKeyCheckResult.length > 0) {\n            // There are foreign key violations, exit\n            throw new ForeignKeyConstraintError({\n              message: `Foreign key violations detected: ${JSON.stringify(foreignKeyCheckResult, null, 2)}`,\n              table: table.tableName,\n            });\n          }\n\n          await Promise.all(\n            indexes.map(async index => {\n              // This index is reserved by SQLite, we can't add it through addIndex and must use \"UNIQUE\" on the column definition instead.\n              if (index.name.startsWith('sqlite_autoindex_')) {\n                return;\n              }\n\n              return this.#sequelize.queryInterface.addIndex(tableName, {\n                ...index,\n                type: undefined,\n                fields: index.fields.map(field => field.attribute),\n              });\n            }),\n          );\n        },\n      );\n    });\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAA0C;AAC1C,yBAA2B;AAE3B,yBAAoC;AAEpC,sCAA+C;AAI/C,0BAAyC;AAElC,MAAM,qCAAqC,+DAA+B;AAAA,EAC/E,YAAqB,SAAwB;AAC3C,UAAM,OAAO;AADM;AAAA,EAErB;AAAA,EAEA,IAAI,aAAwB;AAC1B,WAAO,KAAK,QAAQ;AAAA,EACtB;AAAA,EAEA,IAAI,kBAAwC;AAC1C,WAAO,KAAK,QAAQ;AAAA,EACtB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUA,MAAM,mBACJ,WACA,SACA,SACe;AACf,UAAM,QAAQ,KAAK,gBAAgB,oBAAoB,SAAS;AAEhE,cAAM,8CAAyB,KAAK,YAAY,SAAS,YAAY;AACnE,YAAM,KAAK,WAAW;AAAA,QACpB;AAAA,UACE,UAAU,uCAAoB;AAAA,UAC9B,aAAa,SAAS;AAAA,QACxB;AAAA,QACA,YAAY;AACV,gBAAM,UAAU,MAAM,KAAK,WAAW,eAAe,UAAU,WAAW,OAAO;AACjF,qBAAW,SAAS,SAAS;AAE3B,gBAAI,CAAC,MAAM,KAAK,WAAW,mBAAmB,GAAG;AAC/C;AAAA,YACF;AAEA,gBAAI,CAAC,MAAM,QAAQ;AACjB;AAAA,YACF;AAEA,uBAAW,SAAS,MAAM,QAAQ;AAChC,kBAAI,QAAQ,MAAM,SAAS,GAAG;AAC5B,wBAAQ,MAAM,SAAS,EAAE,SAAS;AAAA,cACpC;AAAA,YACF;AAAA,UACF;AAEA,gBAAM,MAAM,KAAK,gBAAgB,mBAAmB,WAAW,OAAO;AACtE,gBAAM,KAAK,2BAA2B,KAAK,EAAE,GAAG,SAAS,KAAK,KAAK,CAAC;AAGpE,gBAAM,wBAAwB,MAAM,KAAK,WAAW;AAAA,YAClD,KAAK,gBAAgB,qBAAqB,SAAS;AAAA,YACnD;AAAA,cACE,GAAG;AAAA,cACH,MAAM,8BAAW;AAAA,YACnB;AAAA,UACF;AAEA,cAAI,sBAAsB,SAAS,GAAG;AAEpC,kBAAM,IAAI,wCAA0B;AAAA,cAClC,SAAS,oCAAoC,KAAK,UAAU,uBAAuB,MAAM,CAAC;AAAA,cAC1F,OAAO,MAAM;AAAA,YACf,CAAC;AAAA,UACH;AAEA,gBAAM,QAAQ;AAAA,YACZ,QAAQ,IAAI,OAAM,UAAS;AAEzB,kBAAI,MAAM,KAAK,WAAW,mBAAmB,GAAG;AAC9C;AAAA,cACF;AAEA,qBAAO,KAAK,WAAW,eAAe,SAAS,WAAW;AAAA,gBACxD,GAAG;AAAA,gBACH,MAAM;AAAA,gBACN,QAAQ,MAAM,OAAO,IAAI,WAAS,MAAM,SAAS;AAAA,cACnD,CAAC;AAAA,YACH,CAAC;AAAA,UACH;AAAA,QACF;AAAA,MACF;AAAA,IACF,CAAC;AAAA,EACH;AACF;",
  "names": []
}
